<!DOCTYPE html>
<html>
  <head>
    <title>Rack</title>
    <meta charset='utf-8'>
    <meta content='width=1024, user-scalable=no' name='viewport'>
    <!-- deck.js's core css -->
    <link href="deck.js/core/deck.core.css" rel="stylesheet" type="text/css"/>
    <!-- deck.js extension CSS files -->
    <link href="deck.js/extensions/codemirror/deck.codemirror.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/goto/deck.goto.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/hash/deck.hash.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/menu/deck.menu.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/navigation/deck.navigation.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/scale/deck.scale.css" rel="stylesheet" type="text/css"/>
    <link href="deck.js/extensions/status/deck.status.css" rel="stylesheet" type="text/css"/>
    <!-- all css in the css dir: Keydown CSS, your custom CSS, and themes from deck.js -->
    <link href="css/keydown.css" rel="stylesheet" type="text/css"/>
    <link href="css/default.css" rel="stylesheet" type="text/css"/>
    <link href="css/horizontal-slide.css" rel="stylesheet" type="text/css"/>
    <link href="css/rack.css" rel="stylesheet" type="text/css"/>
    <link href="css/swiss.css" rel="stylesheet" type="text/css"/>
    <!-- Modernizr (provided for legacy browsers) -->
    <script src="deck.js/support/modernizr.custom.js" type="text/javascript"></script>
  </head>
  <body class='deck-container keydown'>
    <section class='slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Rack</h1>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>What is Rack</h2>
        
        <ul>
        <li>Project website: Rack provides a minimal interface between webservers supporting Ruby and Ruby frameworks.</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2><a href="http://rack.rubyforge.org/doc/SPEC.html">Rack Spec</a></h2>
        
        <ul>
        <li>Ruby class that responds to <code>call</code></li>
        <li>Take 1 argument the <code>environment</code></li>
        <li>Returns an Array with 3 values: status, headers, and body</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide snippet'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Simplest Example</h2>
        
        <p><textarea class='code' display='none' mode='ruby'># examples/1_simple.ru&#x000A;&#x000A;run lambda { |env| [200, {}, ['Hello World!']] }</textarea>
    </p>
        
        <ul>
        <li>Lambda responds to call</li>
        <li><code>body</code> is an Array because it needs to respond to each</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide snippet'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Class Example</h2>
        
        <p><textarea class='code' display='none' mode='ruby'># examples/2_class.ru&#x000A;&#x000A;class App&#x000A;&#x000A;  def call(env)&#x000A;    [200, {}, ['Hello World!']]&#x000A;  end&#x000A;&#x000A;end&#x000A;&#x000A;run App.new</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Middleware</h2>
        
        <ul>
        <li>Allows you compose a stack of Rack applications</li>
        <li><a href="http://rack.rubyforge.org/doc/Rack/Builder.html">Rack::Build</a> gives us a small DSL to construct our apps</li>
        </ul>
        
        
        <p><textarea class='code' display='none' mode='ruby'># examples/3_middleware.ru&#x000A;&#x000A;class ContentLegthMiddleware&#x000A;&#x000A;  def initialize(app)&#x000A;    @app = app&#x000A;  end&#x000A;&#x000A;  def call(env)&#x000A;    # do work&#x000A;  end&#x000A;end&#x000A;&#x000A;use ContentLegthMiddleware&#x000A;run lambda { |env| [200, {}, ['Hello World!']] }</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2><a href="http://rack.rubyforge.org/doc/Rack/Lint.html">Rack::Lint</a></h2>
        
        <ul>
        <li>Validates your application/middleware against the <a href="http://rack.rubyforge.org/doc/SPEC.html">Rack Spec</a></li>
        <li>When used will show an error page if app violates spec</li>
        </ul>
        
        
        <p><textarea class='code' display='none' mode='ruby'># example/4_lint.ru&#x000A;&#x000A;use Rack::Lint&#x000A;run lambda { |env| [204, {'Content-Length' => '12'}, ['Hello World!']] }</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2><a href="http://rack.rubyforge.org/doc/Rack/URLMap.html">Rack::URLMap</a></h2>
        
        <ul>
        <li>Allows you construct a hash mapping of urls to Rack apps</li>
        <li>Works by changing the SCRIPT_NAME and PATH_INFO variables when dispatching</li>
        </ul>
        
        
        <p><textarea class='code' display='none' mode='ruby'># examples/5_map.ru&#x000A;&#x000A;map "/app_1" do&#x000A;  run lambda { |env| [200, {}, ['Hello from app_1!']] }&#x000A;end&#x000A;&#x000A;map "/app_2" do&#x000A;  map "/nested" do&#x000A;    run lambda { |env| [200, {}, ["SCRIPT_NAME: #{env['SCRIPT_NAME']}\nPATH_INFO: #{env['PATH_INFO']}"]] }&#x000A;  end&#x000A;  run lambda { |env| [200, {}, ['Hello from app_2!']] }&#x000A;end&#x000A;&#x000A;run lambda { |env| [200, {}, ["PATH_INFO: #{env['PATH_INFO']}"]] }</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide snippet'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Rails Router</h2>
        
        <p>The <a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/mapper.rb">Rails Router</a> uses the same principle, every action is Rack app</p>
        
        <p><textarea class='code' display='none' mode='ruby'># This standard route&#x000A;get "/", to: "posts#index"&#x000A;&#x000A;# maps to&#x000A;get "/", to: PostsController.action(:index)</textarea>
    </p>
        
        <p><textarea class='code' display='none' mode='ruby'>mount SintraApp, at: "/sinatra"</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Rails Router</h2>
        
        <h3>Match vs Mount</h3>
        
        <ul>
        <li>Match (get, post, ..) - matches on full path</li>
        <li>Mount (SintraApp) - matches on the path prefix</li>
        </ul>
        
        
        <p><textarea class='code' display='none' mode='ruby'># REQUEST: GET /sinatra/sub_route&#x000A;&#x000A;get "/sinatra/specific", to: "posts#index"&#x000A;&#x000A;mount SintraApp, at: "/sinatra"&#x000A;&#x000A;# other uses&#x000A;mount Sidekiq, at: "/sidekiq"&#x000A;mount Grape::API, at: "/api"</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>rake middleware</h2>
        
        <p><textarea class='code' display='none' mode='ruby'># rails 4 app with Devise&#x000A;use ActionDispatch::Static&#x000A;use Rack::Lock&#x000A;use #<ActiveSupport::Cache::Strategy::LocalCache::Middleware:0x007ff9c2f32d48>&#x000A;use Rack::Runtime&#x000A;use Rack::MethodOverride&#x000A;use ActionDispatch::RequestId&#x000A;use Rails::Rack::Logger&#x000A;use ActionDispatch::ShowExceptions&#x000A;use ActionDispatch::DebugExceptions&#x000A;use ActionDispatch::RemoteIp&#x000A;use ActionDispatch::Reloader&#x000A;use ActionDispatch::Callbacks&#x000A;use ActiveRecord::Migration::CheckPending&#x000A;use ActiveRecord::ConnectionAdapters::ConnectionManagement&#x000A;use ActiveRecord::QueryCache&#x000A;use ActionDispatch::Cookies&#x000A;use ActionDispatch::Session::CookieStore&#x000A;use ActionDispatch::Flash&#x000A;use ActionDispatch::ParamsParser&#x000A;use Rack::Head&#x000A;use Rack::ConditionalGet&#x000A;use Rack::ETag&#x000A;use Warden::Manager&#x000A;run Sample::Application.routes</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='field full-background slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Rack in the "field"</h1>
      </div>
      <div class='spacer bottom'></div>
      <div class='attribution '>
        <a target='_blank'>http://www.flickr.com/photos/arturstaszewski/7048604301</a>
      </div>
    </section>
    <section class='diagram slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Normal API POST Request</h2>
        
        <p><img src="images/api_normal.png" alt="API Normal" /></p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='diagram slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>iPad Drops Connection</h2>
        
        <p><img src="images/api_default.png" alt="API Dropped" /></p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='diagram slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Desired Results</h2>
        
        <p><img src="images/api_desired.png" alt="API Dedup" /></p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>How can we solve this?</h2>
        
        <ul>
        <li>Ruby Module</li>
        <li>Client Defined UUID</li>
        <li>Rack Middleware</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Idempotent Post Middleware</h2>
        
        <p><textarea class='code' display='none' mode='ruby'># examples/idempotent_post.rb&#x000A;&#x000A;module Rack&#x000A;  class IdempotentPost&#x000A;    # ...&#x000A;    def call(env)&#x000A;      return @app.call(env) unless env['REQUEST_METHOD'] == 'POST'&#x000A;&#x000A;      dup_check = DuplicationChecker.new env&#x000A;&#x000A;      if dup_check.duplicate?&#x000A;        headers, body = dup_check.response&#x000A;        [409, headers, body]&#x000A;      else&#x000A;        status, headers, body = @app.call(env)&#x000A;        dup_check.cache_response(status, headers, body)&#x000A;        [status, headers, body]&#x000A;      end&#x000A;    end&#x000A;    # ...&#x000A;  end&#x000A;end</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Idempotent Post Middleware</h2>
        
        <ul>
        <li>Make no changes to your app</li>
        <li>Client just needs handle 409 response</li>
        <li>Can be useful in other part of app
        
        <ul>
        <li>Double submitting forms</li>
        </ul>
        </li>
        <li>Easy to test</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Testing Middleware</h2>
        
        <p><textarea class='code' display='none' mode='ruby'># examples/idempotent_post_spec.rb&#x000A;&#x000A;describe Rack::IdempotentPost do&#x000A;  include Rack::Test::Methods&#x000A;  # ...&#x000A;  def inner_app&#x000A;    lambda do |env|&#x000A;      @inner_app_called += 1&#x000A;      [200, {'Content-Type' => 'text/plain'}, ["Call Count #{@inner_app_called}"]]&#x000A;    end&#x000A;  end&#x000A;&#x000A;  before { @inner_app_called = 0 }&#x000A;&#x000A;  it "returns same response for same request" do&#x000A;    post "/posts", { sample_data: 'sample_value' }&#x000A;    first_repsonse = last_response.body&#x000A;&#x000A;    post "/posts", { sample_data: 'sample_value' }&#x000A;    second_response last_response.body&#x000A;&#x000A;    second_response.should eq first_repsonse&#x000A;    @inner_app_called.should eq 1&#x000A;  end&#x000A;end</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Other ways to use Middleware</h2>
        
        <ul>
        <li>Caching</li>
        <li>Speed up Development &amp; Test Environment</li>
        <li>App Monitoring</li>
        <li>Compression</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Rack Cache</h2>
        
        <ul>
        <li>The middleware you don't know you use</li>
        <li><a href="http://tomayko.com/writings/things-caches-do">Rack Cache Blog Post by Ryan Tomayko</a></li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>App Status</h2>
        
        <ul>
        <li><a href="https://github.com/jbarnette/pinglish">Pinglish</a></li>
        <li>https://github.com/TheClimateCorporation/unicorn-metrics</li>
        <li>More about app status than 200 OK</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Turbo Dev</h2>
        
        <ul>
        <li>Only server assets if they've changed while in dev</li>
        <li>Source: https://github.com/discourse/discourse/blob/master/lib/middleware/turbo_dev.rb</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Cucumber Test Login Backdoor</h2>
        
        <p><textarea class='code' display='none' mode='ruby'># examples/test.rb&#x000A;&#x000A;class DeviseBackDoor&#x000A;  # ...&#x000A;  def call(env)&#x000A;    @env = env&#x000A;    sign_in_through_the_back_door&#x000A;    @app.call(@env)&#x000A;  end&#x000A;&#x000A;  private&#x000A;  def sign_in_through_the_back_door&#x000A;    if user_id = Rack::Utils.parse_query(@env['QUERY_STRING'])['as']&#x000A;      user = User.find(user_id)&#x000A;      @env['warden'].session_serializer.store(user, :user)&#x000A;    end&#x000A;  end&#x000A;end&#x000A;&#x000A;Sample::Application.configure do&#x000A;  # ...&#x000A;  config.middleware.use DeviseBackDoor&#x000A;end</textarea>
    </p>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Cucumber Test Login Backdoor</h2>
        
        <ul>
        <li>Replace sign_in step with <code>root_url(as: @user.id)</code></li>
        <li>Small Suite (64 examples) 4 second speedup (24 > 20)</li>
        <li><a href="http://robots.thoughtbot.com/post/37907699673/faster-tests-sign-in-through-the-back-door">Thoughtbot Clearance Blog Post</a></li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>External Request when Testing</h2>
        
        <ul>
        <li>SpreedlyCore middleware</li>
        <li>Allows the use of VCR</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Compression</h2>
        
        <ul>
        <li>Gzip compression - <a href="https://github.com/rack/rack/blob/master/lib/rack/deflater.rb">Rack::Deflater</a>
        
        <ul>
        <li><a href="http://calebwoods.github.io/http-compression-rails">Slide Deck</a></li>
        <li><a href="https://gist.github.com/calebwoods/5615260">Testing Gist</a></li>
        </ul>
        </li>
        <li>Inline images - <a href="https://github.com/minad/rack-embed">Rack Embed</a></li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Gems that leverage Middleware</h2>
        
        <ul>
        <li><a href="https://github.com/charliesome/better_errors">Better Errors</a></li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h2>Other ideas</h2>
        
        <ul>
        <li><a href="https://github.com/rack/rack-contrib/blob/master/lib/rack/contrib/mailexceptions.rb">Email Exceptions</a></li>
        <li><a href="https://github.com/rack/rack/blob/master/lib/rack/directory.rb">Directory Viewer</a></li>
        <li><a href="https://github.com/cookrn/chrome_logger">Chrome Logger</a></li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Questions</h1>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Resources</h1>
        
        <ul>
        <li>Jose Valim - <a href="http://www.confreaks.com/videos/2442-railsconf2013-you-ve-got-a-sinatra-on-your-rails">You've a got a Sinatra on your Rails [RailsConf 2013]</a>
        
        <ul>
        <li>Great look how Rails uses Rack internally</li>
        </ul>
        </li>
        <li>RailsCast - <a href="http://railscasts.com/episodes/317-rack-app-from-scratch">Rack App from Scratch</a></li>
        <li>Jason Seifer - <a href="http://jasonseifer.com/2009/04/08/32-rack-resources-to-get-you-started">32 Rack Resources to get you Started</a></li>
        <li><a href="https://github.com/rack/rack/wiki/List-of-Middleware">List of Rack Middleware</a></li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <section class='left slide'>
      <div class='spacer top'></div>
      <div class='content'>
        <h1>Feedback</h1>
        
        <ul>
        <li>Github repo:</li>
        <li>Email: <a href="mailto:caleb.woods@rolemodelsoftware.com">caleb.woods@rolemodelsoftware.com</a></li>
        <li>Traingle.rb Mailing List</li>
        </ul>
      </div>
      <div class='spacer bottom'></div>
    </section>
    <!-- deck.js navigation extension -->
    <a class='deck-prev-link' href='#' title='Previous'>&#8592;</a>
    <a class='deck-next-link' href='#' title='Next'>&#8594;</a>
    <!-- deck.js hash extension -->
    <a class='deck-permalink' href='.' title='Permalink to this slide'>#</a>
    <!-- deck.js status extension -->
    <p class='deck-status'>
      <span class='deck-status-current'></span>
      /
      <span class='deck-status-total'></span>
    </p>
    <!-- jQuery & deck.js -->
    <script src="deck.js/support/jquery.1.6.4.min.js" type="text/javascript"></script>
    <script src="deck.js/core/deck.core.js" type="text/javascript"></script>
    <!-- deck.js extension JS files -->
    <script src="deck.js/extensions/codemirror/codemirror.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/deck.codemirror.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/clike/clike.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/clojure/clojure.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/coffeescript/coffeescript.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/css/css.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/diff/diff.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/haskell/haskell.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/htmlmixed/htmlmixed.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/javascript/javascript.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/lua/lua.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/php/php.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/plsql/plsql.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/python/python.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/r/r.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/rst/rst.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/ruby/ruby.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/scheme/scheme.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/smalltalk/smalltalk.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/sparql/sparql.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/stex/stex.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/velocity/velocity.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/xml/xml.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/xmlpure/xmlpure.js" type="text/javascript"></script>
    <script src="deck.js/extensions/codemirror/mode/yaml/yaml.js" type="text/javascript"></script>
    <script src="deck.js/extensions/goto/deck.goto.js" type="text/javascript"></script>
    <script src="deck.js/extensions/hash/deck.hash.js" type="text/javascript"></script>
    <script src="deck.js/extensions/menu/deck.menu.js" type="text/javascript"></script>
    <script src="deck.js/extensions/navigation/deck.navigation.js" type="text/javascript"></script>
    <script src="deck.js/extensions/scale/deck.scale.js" type="text/javascript"></script>
    <script src="deck.js/extensions/status/deck.status.js" type="text/javascript"></script>
    <!-- your custom JS here, including call to initialize deck.js-codemirror -->
    <script src="js/rack.js" type="text/javascript"></script>
    <!-- Initialize the deck. -->
    <script type='text/javascript'>
      $(function() { $.deck('.slide'); });
    </script>
  </body>
</html>
